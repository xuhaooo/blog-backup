## 一、同源限制
> 浏览器安全的基石是“同源政策”
### 1. 同源
- 如果两个网页的 URL 的**协议**、**域名**、**端口**相同
- 那么这两个网页就是**同源**的
### 2. 如何获得当前源
- 打印当前网页的 `window.origin` 或 `location.origin` 即可获得
### 3. 同源策略
- 浏览器规定：不同源的网页之间，一些行为会被限制，包括：
> 无法读取非同源网页的 Cookie、LocalStorage 和 IndexedDB<br>
> 无法接触非同源网页的 DOM<br>
> 无法向非同源地址发送 AJAX 请求（可以发送，但浏览器会拒绝接受响应）<br>
- 实际上，同源策略限制的是数据访问，我们在引用不同源的 CSS、JS 文件的时候，我们并不知道其内部的数据，只是仅仅在引用而已
### 4. 目的
- 同源限制是浏览器故意设计的功能
- 为了保证用户信息的安全，防止恶意的网站窃取数据
- 如果没有同源限制，那么互联网上的每一个成员都将没有任何隐私可言
### 5. 根源
- 浏览器无法区分请求的发送者
- 如果没有同源限制网页中的 JS 请求几乎没有区别（referer 有区别）
- 如果后台开发人员没有检查 referer，那么网页的数据可能会全部被窃取
- 总之，浏览器为了用户隐私安全考虑，设置了严格的同源策略

## 二、跨域
> 虽然同源限制是必要的，但是有时很不方便，一些合理的用途也会受到影响，于是便有了跨域操作
### 1. CORS
> CORS 需要浏览器和服务器同时支持。整个 CORS 过程都是浏览器自动完成，不需要用户参与。对开发者来说，CORS 和普通 AJAX 通信没有区别，代码完全相同。浏览器一旦发现 AJAX 请求，就会自动添加一些头信息，但用户不会感知。因此，CORS 的关键是服务器，只要服务器实现了 CORS 接口，就可以跨域通信
#### 实现 CORS 通信的过程
- 在发送 AJAX 请求时，浏览器发现该请求收到同源限制，会在请求头信息之中，增加一个 Origin 字段说明本次请求来自哪个域
- 服务器根据这个值来确定是否同意这次请求
- 如果同意请求，就在响应头信息中设置一个响应头信息：Access-Control-Allow-Origin
- 浏览器根据响应头中是否有该字段，来决定返回响应数据还是返回错误
```js
response.setHeader('Access-Control-Allow-Origin', 'https://www.example.com')
```
- 如果需要允许多个网页的跨域访问呢？
- 服务器读取 referer，然后将 referer 的协议、域名、端口设置到响应头参数即可

### 2. JSONP
#### 具体做法
> 1.客户端在网页中添加一个 `script` 标签，向服务器请求一个脚本，这不受同源限制可以实现跨域请求
- 注意，请求的脚本网址有一个 `callback` 参数，用来告诉服务器客户端的回调函数名称
> 2.服务器在接收到请求后，拼接一个字符串，将 JSON 数据放在回调函数参数位置，作为字符串返回<br>
> 3.客户端会将服务器返回的数据，作为代码解析。因为浏览器认为，这是 script 标签请求的脚本内容。这时，客户端需要定义一个上面说到的回调函数，就能在函数体内，拿到服务器返回的 JSON 数据
- 由于是通过 `script` 请求的脚本，直接作为代码执行，这时，只要浏览器定义了 fn 函数，该函数就会立即调用，于是我们就拿到了想要的数据
- 由于作为参数的 JSON 数据被视为 JS 对象而不是字符串，因为避免了 JSON.parse 这一步
- 最后，JSONP 跨域访问需要服务器开发的后端配合才能实现，另外，callback 参数的函数名最好做一下随机生成处理
```js
// 客户端实现
function addScriptTag(src) {
  var script = document.createElement('script')
  script.setAttribute('type', 'text/javascript')
  script.src = src
  document.body.appendChild(script)
}
window.onload = function () {
  addScriptTag('http://example.com?callback=fn')
}
function fn(data) {
  console.log(data)
}
script.onload = function () {
    script.remove
}
// 服务器实现
fn({
  'name': 'Tom',
  'age':18
})
```
#### 总结
- JSONP 是啥

我们在做跨域请求时，由于某些限制不支持 CORS，必须使用另外一种方式来跨域。于是我们通过请求一个 JS 文件，这个 JS 文件执行一个回调，回调中我们可以拿到想要的数据
- 回调的名字是啥

回调的名字可以随机生成，我们把随机生成的名字以 callback 的参数传给后台，后台把数据放入这个函数返回给我们并执行
- JSONP 的优缺点

兼容 IE，可以实现跨域；
不支持 POST 请求，因为因为是通过 script 标签发送的请求